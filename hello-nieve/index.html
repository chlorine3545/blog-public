<!doctype html><html lang="zh-CN"><head><title>园子里的日光</title>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="referrer" content="no-referrer"><meta name="description" content="本文介绍了作者构建名为 Nieve 的图片服务系统的过程。由于原先使用的缤纷云图床出现加载问题，博主决定迁移至又拍云作为主图床，并以 Cloudflare R2 作为备份。迁移过程中，使用了 &#x60;rclone&#x60; 工具进行图片备份和上传。为了优化 Obsidian 中的写作体验，博主弃用了原先的 Image Converter 插件，转而利用 Shell Commands 插件调用自定义脚本。这些脚本实现了图片粘贴时的自动压缩（使用 &#x60;cavif&#x60;）、重命名、相对路径计算，以及发布文章时查找图片、上传至又拍云（使用官方工具 &#x60;upx&#x60;）并替换链接的功能。整个过程涉及了多种工具，包括 Python 脚本、AppleScript、&#x60;ripgrep&#x60; 等，最终构建了一个自动化、高效的图片处理与发布流程。"><meta name="keywords" content="博客,图床,Obsidian"><meta name="application-name" content="园子里的日光"><meta name="apple-mobile-web-app-title" content="园子里的日光"><meta name="theme-color" content="#ffffff" media="(prefers-color-scheme: light)"><meta name="theme-color" content="#1a1b1e" media="(prefers-color-scheme: dark)"><meta property="og:title" content="理想乡构筑手记（3）：Hello，Nieve - 园子里的日光"><meta property="og:description" content="本文介绍了作者构建名为 Nieve 的图片服务系统的过程。由于原先使用的缤纷云图床出现加载问题，博主决定迁移至又拍云作为主图床，并以 Cloudflare R2 作为备份。迁移过程中，使用了 &#x60;rclone&#x60; 工具进行图片备份和上传。为了优化 Obsidian 中的写作体验，博主弃用了原先的 Image Converter 插件，转而利用 Shell Commands 插件调用自定义脚本。这些脚本实现了图片粘贴时的自动压缩（使用 &#x60;cavif&#x60;）、重命名、相对路径计算，以及发布文章时查找图片、上传至又拍云（使用官方工具 &#x60;upx&#x60;）并替换链接的功能。整个过程涉及了多种工具，包括 Python 脚本、AppleScript、&#x60;ripgrep&#x60; 等，最终构建了一个自动化、高效的图片处理与发布流程。"><meta property="og:type" content="article"><meta property="og:url" content="https://chlor.me/hello-nieve/"><meta property="og:site_name" content="园子里的日光"><meta property="article:published_time" content="2025-02-21T00:00:00+00:00"><meta property="article:modified_time" content="2025-02-21T00:00:00+00:00"><meta property="article:author" content="Chlorine"><meta property="article:tag" content="博客"><meta property="article:tag" content="图床"><meta property="article:tag" content="Obsidian"><meta property="article:section" content="百草园"><meta property="og:image" content="https://img.clnya.fun/cover/hello-nieve-cover.webp"><title>理想乡构筑手记（3）：Hello，Nieve | 园子里的日光</title>
<link rel="icon" href="/favicon.svg" type="image/svg+xml"><script>(function(){const e=localStorage.getItem("theme")||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");(e==="dark"||e==="auto"&&window.matchMedia("(prefers-color-scheme: dark)").matches)&&document.documentElement.classList.add("dark")})()</script><link rel="stylesheet" href="/css/main.min.e464c965adcb359ccf50018707280010cd22711ea4585b4f4f3a54d6cefb9f9f.css" integrity="sha256-5GTJZa3LNZzPUAGHBygAEM0icR6kWFtPTzpU1s77n58=" crossorigin="anonymous"><link rel="stylesheet" href="/css/uno.min.3e9bb6d280f8af364980f77738039c0dde411f1fb47929a3aea41d71dac53e79.css" integrity="sha256-Ppu20oD4rzZJgPd3OAOcDd5BHx+0eSmjrqQdcdrFPnk=" crossorigin="anonymous"><link rel="stylesheet" href="/css/prose.min.93e5efa948cb99fe3c47b2bfcb0cd3093495aaca40bd57c9325b212fc6885dc3.css" integrity="sha256-k+XvqUjLmf48R7K/ywzTCTSVqspAvVfJMlshL8aIXcM=" crossorigin="anonymous"><link rel="stylesheet" href="/css/lightbox.min.b5dcdf37dfd51fbab023d00fd8e89fbff7c0e0d13bb42bee87f2ea59a5e3f42c.css" integrity="sha256-tdzfN9/VH7qwI9AP2Oifv/fA4NE7tCvuh/LqWaXj9Cw=" crossorigin="anonymous"><link rel="stylesheet" href="/css/scroll.min.c86a4db3c7b214919b90295be86a8ac6490610845c0f6d8cd8cc7d230478a22e.css" integrity="sha256-yGpNs8eyFJGbkClb6GqKxkkGEIRcD22M2Mx9IwR4oi4=" crossorigin="anonymous"><link rel="stylesheet" href="/css/components/article/shiki.min.c0e6db88b257cd1eb6333abe1275a053124ebdc0c8e7c930a89591f44c43c577.css" integrity="sha256-wObbiLJXzR62Mzq+EnWgUxJOvcDI58kwqJWR9ExDxXc=" crossorigin="anonymous"><link rel="stylesheet" href="/css/components/article/clickcopy.min.84a456e78e8f6cbbd747aa26ded29875ddb051d01f29ff9185ebd9aee32ef397.css" integrity="sha256-hKRW546PbLvXR6om3tKYdd2wUdAfKf+RhevZruMu85c=" crossorigin="anonymous"><link rel="stylesheet" href="/css/custom.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css" integrity="sha256-47DEQpj8HBSa+/TImW+5JCeuQeRkm5NMpJWZG3hSuFU=" crossorigin="anonymous"><script src="/js/components/lightbox.9bc8b6a23d67e97480f013aa933f45e43ff50ca0f5ad37b9b4da1db6ce09b901.js" integrity="sha256-m8i2oj1n6XSA8BOqkz9F5D/1DKD1rTe5tNodts4JuQE=" crossorigin="anonymous" defer></script><script src="/js/components/clickcopy.5bbf4d054a73a21043f7d84298fc4772b74b329b7609640ee165a537d054c93c.js" integrity="sha256-W79NBUpzohBD99hCmPxHcrdLMpt2CWQO4WWlN9BUyTw=" crossorigin="anonymous" defer></script></head><body class="flex flex-col min-h-screen bg-background text-foreground dark:bg-background-dark dark:text-foreground-dark transition-colors"><div id="loading-screen" class="fixed inset-0 z-[100] bg-background flex items-center justify-center transition-opacity duration-500"><div class="flex flex-col items-center gap-4"><div class="relative w-12 h-12"><div class="absolute inset-0 border-t-2 border-primary/20 rounded-full"></div><div class="absolute inset-0 border-t-2 border-primary rounded-full animate-spin"></div></div><div class="flex items-center gap-2"><div class="w-1.5 h-1.5 rounded-full bg-primary/80 animate-bounce-delay-1"></div><div class="w-1.5 h-1.5 rounded-full bg-primary/80 animate-bounce-delay-2"></div><div class="w-1.5 h-1.5 rounded-full bg-primary/80 animate-bounce-delay-3"></div></div><div class="text-sm text-muted-foreground/70 animate-pulse">别着急，坐和放宽</div></div></div><div class="flex flex-col flex-grow"><nav class="fixed top-0 left-0 right-0 bg-background/80 dark:bg-background-dark/80 backdrop-blur z-50"><div class="container max-w-6xl mx-auto px-4 flex items-center h-16"><a href="/" class="shrink-0"><img src="https://img.clnya.fun/avatar/01.webp" alt="avatar" class="w-8 h-8 rounded-full object-cover ring-2 ring-background dark:ring-background-dark shadow-sm"></a><div class="flex mx-auto transition-all duration-300" id="nav-menu"><div class="flex items-center bg-accent/50 dark:bg-accent-dark/50 backdrop-blur rounded-full px-4 h-9 gap-6 text-sm font-medium"><div class="relative group"><a aria-label="归档" href="https://chlor.me/" class="text-muted-foreground hover:text-primary transition-colors">归档</a><div class="absolute top-full left-1/2 -translate-x-1/2 pt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200"><div class="w-32 py-1 rounded-lg border border-border/50 dark:border-border-dark/50 backdrop-blur shadow-lg shadow-accent/5 flex flex-col overflow-hidden"><a aria-label="分类" href="https://chlor.me/categories" class="px-2 py-1.5 text-center text-muted-foreground/70 dark:text-muted-foreground-dark/70 hover:text-primary hover:bg-accent/40 dark:hover:bg-accent-dark/40 transition-colors">分类
</a><a aria-label="时间" href="https://chlor.me/posts" class="px-2 py-1.5 text-center text-muted-foreground/70 dark:text-muted-foreground-dark/70 hover:text-primary hover:bg-accent/40 dark:hover:bg-accent-dark/40 transition-colors">时间
</a><a aria-label="标签" href="https://chlor.me/tags" class="px-2 py-1.5 text-center text-muted-foreground/70 dark:text-muted-foreground-dark/70 hover:text-primary hover:bg-accent/40 dark:hover:bg-accent-dark/40 transition-colors">标签
</a><a aria-label="系列" href="https://chlor.me/series" class="px-2 py-1.5 text-center text-muted-foreground/70 dark:text-muted-foreground-dark/70 hover:text-primary hover:bg-accent/40 dark:hover:bg-accent-dark/40 transition-colors">系列</a></div></div></div><a aria-label="友链" href="https://chlor.me/links" class="text-muted-foreground dark:text-muted-foreground-dark hover:text-primary transition-colors">友链
</a><a aria-label="如今" href="https://chlor.me/now" class="text-muted-foreground dark:text-muted-foreground-dark hover:text-primary transition-colors">如今
</a><a aria-label="关于" href="https://chlor.me/about" class="text-muted-foreground dark:text-muted-foreground-dark hover:text-primary transition-colors">关于</a></div></div><div class="absolute left-1/2 -translate-x-1/2 opacity-0 cursor-pointer transition-all duration-300 max-w-[50%] sm:max-w-[60%]" id="nav-title"><h2 class="text-base font-medium truncate hover:text-primary transition-colors" onclick="window.scrollTo({top:0,behavior:&#x22;smooth&#x22;})" aria-label="返回顶部">理想乡构筑手记（3）：Hello，Nieve</h2></div><div class="flex items-center gap-2"><button type="button" id="search-button" class="shrink-0 inline-flex items-center justify-center w-9 h-9 rounded-full bg-background/80 dark:bg-background-dark/80 ring-0 dark:ring-0 border-0 dark:border-0 text-muted-foreground/70 dark:text-muted-foreground-dark/70 hover:bg-accent/50 dark:hover:bg-accent-dark/50 transition-colors" aria-label="搜索" onclick="document.querySelector(&#x22;.DocSearch-Button&#x22;).click()"><div class="i-carbon-search w-4 h-4"></div></button><div class="relative group"><button id="theme-toggle" class="shrink-0 inline-flex items-center justify-center w-9 h-9 rounded-full bg-background/80 ring-0 border-0 text-muted-foreground/70 hover:bg-accent/50 transition-colors" aria-label="切换主题"><div class="i-carbon-sun w-4 h-4"></div></button><div class="absolute right-0 top-full mt-2 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-200"><div class="w-9 flex flex-col rounded-xl shadow-sm shadow-accent/5"><button class="w-9 h-9 flex items-center justify-center rounded-full bg-background ring-1 ring-border dark:ring-white/40 border-0 text-muted-foreground/70 hover:bg-accent/50 hover:text-foreground transition-colors my-0.5" onclick="setTheme(&#x22;light&#x22;)" aria-label=""><div class="i-carbon-sun w-4 h-4"></div></button>
<button class="w-9 h-9 flex items-center justify-center rounded-full bg-background ring-1 ring-border dark:ring-white/40 border-0 text-muted-foreground/70 hover:bg-accent/50 hover:text-foreground transition-colors my-0.5" onclick="setTheme(&#x22;dark&#x22;)" aria-label=""><div class="i-carbon-moon w-4 h-4"></div></button>
<button class="w-9 h-9 flex items-center justify-center rounded-full bg-background ring-1 ring-border dark:ring-white/40 border-0 text-muted-foreground/70 hover:bg-accent/50 hover:text-foreground transition-colors my-0.5" onclick="setTheme(&#x22;auto&#x22;)" aria-label=""><div class="i-carbon-screen w-4 h-4"></div></button></div></div></div></div></div></nav><link rel="preconnect" href="https://6O8RM1BUT3-dsn.algolia.net" crossorigin=""><link rel="stylesheet" href="https://cdn.jsdmirror.com/npm/@docsearch/css@3" crossorigin="anonymous"><link rel="stylesheet" href="/css/components/search/docsearch.min.e9ab6523c0591ffe9d81ad080ff72fb1b120253095c4d22c3772cc170c9eec2e.css" integrity="sha256-6atlI8BZH/6dga0ID/cvsbEgJTCVxNIsN3LMFwye7C4=" crossorigin="anonymous"><div id="docsearch"></div><script src="https://cdn.jsdmirror.com/npm/@docsearch/js@3" crossorigin="anonymous" defer></script><script>document.addEventListener("DOMContentLoaded",function(){docsearch({appId:"6O8RM1BUT3",apiKey:"ceb081eaca8bade865cec00ef9e754e8",indexName:"yoghurtlee",container:"#docsearch",placeholder:"Nyanpasu~"})})</script><script>function getTheme(){const e=localStorage.getItem("theme");return e?e:window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}function setTheme(e){const t=document.documentElement;if(t.classList.remove("light","dark"),e==="dark")t.classList.add("dark");else if(e==="light")t.classList.add("light");else{const e=window.matchMedia("(prefers-color-scheme: dark)").matches;e?t.classList.add("dark"):t.classList.add("light")}localStorage.setItem("theme",e),updateThemeIcon(e)}function updateThemeIcon(e){const t=document.getElementById("theme-toggle"),n=e==="dark"?"i-carbon-moon":e==="light"?"i-carbon-sun":"i-carbon-screen";t.innerHTML=`<div class="${n} w-4 h-4 text-muted-foreground/70 dark:text-muted-foreground-dark/70"></div>`}document.addEventListener("DOMContentLoaded",function(){const e=getTheme();setTheme(e),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",e=>{localStorage.getItem("theme")==="auto"&&setTheme("auto")})}),document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("nav-menu"),t=document.getElementById("nav-title");let s=window.scrollY;const o=100;function n(){const n=window.scrollY;n>o?(e.style.opacity="0",e.style.pointerEvents="none",t.style.opacity="1",t.style.pointerEvents="auto"):(e.style.opacity="1",e.style.pointerEvents="auto",t.style.opacity="0",t.style.pointerEvents="none"),s=n}window.addEventListener("scroll",n),n()})</script><main class="flex-grow"><div class="container max-w-6xl mx-auto px-4 pt-24 pb-16"><div class="flex gap-16"><div class="relative"><div class="flex gap-8 max-w-6xl mx-auto px-4 py-12 md:py-20"><div class="w-full lg:max-w-3xl"><header class="mb-12"><h1 class="text-3xl font-bold mb-6">理想乡构筑手记（3）：Hello，Nieve</h1></header><link rel="stylesheet" href="/css/components/article/ai-summary.min.2cc7520c09092e75a992b583187a21d1f73b0ef9439f84adeb1a8c4a16636c6a.css" integrity="sha256-LMdSDAkJLnWpkrWDGHoh0fc7DvlDn4St6xqMShZjbGo=" crossorigin="anonymous"><div class="ai-summary" data-component="ai-summary"><input type="checkbox" id="ai-summary__checkbox" class="ai-summary__checkbox absolute opacity-0">
<label for="ai-summary__checkbox" class="cursor-pointer block"><div class="ai-summary__container relative my-8 p-6 rounded-xl border border-border/40 backdrop-blur transition-all duration-300 hover:border-border/60"><div class="ai-summary__header flex items-center justify-between"><div class="ai-summary__title flex items-center gap-3"><div class="i-carbon-ai-status w-5 h-5 text-primary"></div><span class="text-base font-medium">AI 摘要</span></div><div class="ai-summary__controls flex items-center gap-3"><span class="ai-summary__badge px-2.5 py-0.5 text-xs rounded-md text-primary/80 dark:text-primary-dark/80 ring-1 ring-primary/20 dark:ring-primary-dark/20">109酱</span><div class="ai-summary__toggle group bg-inherit border-none ring-1 ring-gray-600 dark:ring-gray-400" aria-label="展开/收起摘要"><div class="ai-summary__icon i-carbon-chevron-down w-5 h-5 text-muted-foreground/60 transition-transform duration-200 ease-out"></div></div></div></div><div class="ai-summary__divider my-4 border-t border-border/30"></div><div class="ai-summary__content"><div class="ai-summary__text text-sm leading-relaxed text-muted-foreground">本文介绍了作者构建名为 Nieve 的图片服务系统的过程。由于原先使用的缤纷云图床出现加载问题，博主决定迁移至又拍云作为主图床，并以 Cloudflare R2 作为备份。迁移过程中，使用了 `rclone` 工具进行图片备份和上传。为了优化 Obsidian 中的写作体验，博主弃用了原先的 Image Converter 插件，转而利用 Shell Commands 插件调用自定义脚本。这些脚本实现了图片粘贴时的自动压缩（使用 `cavif`）、重命名、相对路径计算，以及发布文章时查找图片、上传至又拍云（使用官方工具 `upx`）并替换链接的功能。整个过程涉及了多种工具，包括 Python 脚本、AppleScript、`ripgrep` 等，最终构建了一个自动化、高效的图片处理与发布流程。</div></div></div></label></div><article class="prose max-w-none"><p>诸位老友，上午好，这里是 Chlorine。</p><p>本期是「理想乡构筑手记」的第三篇，实际也是最早进行的一篇，主题是园子的图片服务系统——Nieve。本来是想放到新的一期周报里面讲的（<del>没想到吧，园子的周报还活着</del>），但是这部分内容实在是太琐碎了，遂单题一篇。<del>水，你接着水</del>。</p><p>Nieve 这个名字，也是很久以前就想好的。这个词是西班牙语，意思是「雪」。</p><h2 id="tl--dr">TL ; DR</h2><ul><li>在 Obsidian 写作时粘贴图片前使用 Shell Commands 的自定义脚本压缩图片为 AVIF，并获取压缩后链接。</li><li>使用 Shell Commands 的另一个自定义脚本上传博客图片到又拍云和 Cloudflare R2</li><li>又拍云作为主图床，Cloudflare R2 作为对外的图片服务和备份图床</li></ul><h2 id="前言">前言</h2><p>作为 Vercel 上的静态博客，园子的图片当然使用的是图床。小氯使用的图床服务几经变易，从免费图床的良心之作 <a href="https://smms.app">SMMS</a> 到牢巴（Alibaba）的阿里云 OSS，再到缤纷云，期间甚至还写了<a href="/markdown-pic-management/">一篇将近一万字的文章</a>去讲 Markdown 图片管理（当然那篇文章其实挺水的）。缤纷云提供了相当慷慨的免费额度，具体来说是：</p><ul><li>前 50 GiB 存储</li><li>每月前 10*3 GB HTTP/HTTPS 流量（每日每项限 5 GB）<ul><li>S4 出口流量 10GB/月</li><li>内置 CDN 回源 S4 流量 10GB/月</li><li>内置 CDN 出口流量 10GB/月</li></ul></li><li>每月前 10*3 万次请求（每日每项限 1 万次）<ul><li>S4 请求数 10 万次/月</li><li>内置 CDN 回源 S4 请求数 10 万次/月</li><li>内置 CDN 请求数 10 万次/月</li></ul></li></ul><p>回来。小氯使用缤纷云已经有快一年了，总体而言速度和稳定性还算可以，有了备案之后还可以用他家的 CDN，可以省一些回源流量之类的（没错，速度其实没快多少）。当然，为了避免免费服务的传统艺能——跑路。小氯也把图片在赛博活佛 Cloudflare 的 R2 上存了一份。和国内的各大对象存储以及 Amazon S3 等同行相比，Cloudflare 的免费额度简直多得不像话，一个月有 10G 的免费空间，1M 次的 A 类操作（存储和删除等），10M 次的 B 类操作（读取等），无限流量。如果不在意国内速度慢一点，那么 Cloudflare R2 堪称是对象存储中的椎间盘——为何你如此突出。</p><p>插一句话，小氯写到这里的时候，习惯性地希望使用中文，然后发现自己似乎不知道 Cloudflare 的中文名字……等等，Cloudflare 有中文名字吗？</p><p>这个还真难说。Cloudflare 的官网在调为简中后，还是叫作 Cloudflare；而 <code>cloudflare-cn.com</code> 使用的是「科赋锐」（注意：小氯不清楚这个网站和 Cloudflare 官方是否有关，请谨慎），说实话，这个名字……真的让小氯很不满意，就和把 Google 翻译为「谷歌」一样。小氯还没有找到一个被 Cloudflare 官方认可的中文名字，但是从社区来看，似乎有一个不错的选择：<strong>云帆</strong>。</p><p>「云」对应 cloud，由于「云计算」「云存储」这些词汇的广泛使用，所以用这个词代表相关的技术领域没什么问题；而「帆」是 flare 的音译（其原意为火焰）。这个词整体读起来还比较顺口，而且寓意也很好，「直挂云帆济沧海」。不过如果在正式的技术讨论里面，还是用 Cloudflare 为好。</p><p>回来。不过最近（其实离文章发出来已经是几个月之前了），小氯接到了一些老友的反映，博客的图片加载明显变慢了，甚至很多裂掉了（即无法加载）。直接用 URL 看一下，发现 403。奇怪的是，小氯并没有为这种情况加任何的访问限制，而图片也都好好地在那。而当我希望将新的自定义 URL 添加到 CDN 中时，也是一直提示「未备案」（实际上 ICP 和公安备案已经过了快一个月了）。这可不是什么好兆头，说明缤纷云的后端设施可能出了一些问题。此外，小氯发现自己的流量似乎也出了点差错，其用量比实际应该有的流量高。而其分布也比较均匀，不像是攻击（<del>而且谁闲着没事去攻击小氯酱这条杂鱼啊</del>）。</p><p>总而言之，种种因素作用吧，小氯打算换个图片服务了。</p><h2 id="图片服务的选择">图片服务的选择</h2><p>市面上的图片服务——准确来说，能直接或者间接作为图片服务的服务不胜枚举。虽然说小氯不介意花点小钱，但是如果是像流量费这种很可能让人倾家荡产的服务，小氯还是希望尽可能避免的。于是小氯开始收集各种有免费额度的服务，当然这里指的是国内的。我没备案用的是国外的图片服务，备案了用得还是国外的图片服务，那我这不是白备案了嘛。</p><p>具体过程不多说了，极其曲折。小氯甚至想过用服务器 + 一些 CDN 搭一个，但一是没有合适的服务器，二是这种方式相当不稳定。举个例子：<a href="https://dusays.com">杜老师</a>的<a href="https://7bu.top">去不图床</a>，可以说是博友圈最著名的自建图床了（甚至没有之一），也时常会出现许多奇奇怪怪的问题，小氯可不认为自己的运维能力和服务器集群的质量比杜老师强。所以还是老老实实地找对象存储去了。</p><p>几番搜索，小氯找到了一个看起来还可以的选择。这个家伙大家也都不陌生：<a href="https://upyun.com">又拍云</a>（这个链接不带 AFF，放心点击）。</p><p>牢拍也算是小有名气的商家了，跑路的风险不大，而且也没有大到像套路云、凉心云那样令人讨厌的规模。此外牢拍有一个著名的 League，简单来说就是在自己网站底下挂上牢拍的 logo 可以持续领到代金券，均摊一下也就是每个月 10G 的空间和 15G 的流量，基本上够用一段时间了。而且牢拍的代金券是和账户而不是域名挂钩的，这意味着你只需要找一个备案过的域名挂一下，然后就可以随便用了。</p><p>那么……就是你了。</p><h2 id="使用-rclone-备份图片">使用 <code>rclone</code> 备份图片</h2><p>在转移到牢拍之前，我们当然需要把整个图片目录备份下来。这里小氯打算试一下新玩具 <a href="https://rclone.org">rclone</a>。</p><p>rsync 咱都知道，一个有趣的文件传输（这里说的是上传、下载和同步）工具。rsync 的花样很多，甚至可以用它部署静态博客到服务器（这可能是最好的方案之一，不需要装 Gitea 等一堆东西）。rclone 大体可以理解为云存储版的 rsync，支持一大堆各种各样的云存储和云盘。</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">brew</span><span style="color:#50A14F;--shiki-dark:#98C379"> update</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> &#x26;&#x26; </span><span style="color:#4078F2;--shiki-dark:#61AFEF">brew</span><span style="color:#50A14F;--shiki-dark:#98C379"> install</span><span style="color:#50A14F;--shiki-dark:#98C379"> rclone</span></span></code></pre><p>先创建一下配置：</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">rclone</span><span style="color:#50A14F;--shiki-dark:#98C379"> config</span></span></code></pre><p>下一步输入 n，新建一个配置，选择 S3 - 其他，把 Access Key ID 和 Secret Key ID 之类的参数扔进去就行。</p><p>配置好以后，运行：</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">rclone</span><span style="color:#50A14F;--shiki-dark:#98C379"> ls</span><span style="color:#50A14F;--shiki-dark:#98C379"> your-service-name:your-bucket</span></span></code></pre><p>如果能输出你的桶目录结构那就配置成功了，可以下载了：</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">rclone</span><span style="color:#50A14F;--shiki-dark:#98C379"> copy</span><span style="color:#50A14F;--shiki-dark:#98C379"> your-service-name:your-bucket</span><span style="color:#50A14F;--shiki-dark:#98C379"> /your/path</span></span></code></pre><p>完工。</p><h2 id="又拍云的配置">又拍云的配置</h2><h3 id="申请又拍云联盟">申请又拍云联盟</h3><p>略。注册之后在<a href="https://www.upyun.com/league">这里</a>申请即可。一般来说审核会有 1 ~ 3 天，小氯的用了大概二十分钟，相当快。</p><h3 id="创建存储服务">创建存储服务</h3><p>和缤纷云不同的是，牢拍的云存储自带 CDN，所以只创建一个存储服务即可。</p><h3 id="使用-rclone-重新上传图片">使用 <code>rclone</code> 重新上传图片</h3><p>USS 兼容 S3，这就意味着我们可以用我们熟悉的各种小道具去把玩 USS。这里为了方便，我们还是使用 rclone 吧。这里小氯踩了点坑，因此说得详细一些。</p><p>首先我们需要获得 USS 的 S3 兼容凭据。这可不是你那个操作员的操作凭据，需要在存储服务的控制界面 - 存储管理里面找这里：</p><p></p><figure class="my-8"><img src="https://img.clnya.fun/20250220-upyun-uss-s3.avif" alt="upyun-uss-s3" class="mx-auto rounded-lg block" loading="lazy"></figure><p></p><p>把东西记好喽。</p><p>回到终端，创建一个 rclone 配置：</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">rclone</span><span style="color:#50A14F;--shiki-dark:#98C379"> config</span></span></code></pre><p>输入 n 新建配置，名字随便起，这里我使用 <code>test</code> 作为演示。</p><p>下面依次跟随指示，键入以下配置。这里的数字是以 <code>v1.69.0</code> 为基础的，在键入前，请检查你的版本的相应配置对应于哪个数字：</p><ul><li><code>Storage</code>：4（Amazon S3 及其兼容服务）</li><li><code>provider</code>：34（其他 S3 兼容服务提供商）</li><li><code>env_auth</code>：直接回车，使用默认配置即可。</li><li><code>access_key_id</code>：你刚才获取的那个 <code>access_key_id</code>。</li><li><code>secret_access_key</code>：还是刚才那个。</li><li><code>region</code>：直接回车，使用默认配置即可。</li><li><code>endpoint</code>：<code>s3.api.upyun.com</code></li><li><code>location_constraint</code>：直接回车，使用默认配置即可。</li><li><code>acl</code>：直接回车，使用默认配置即可。</li><li>高级设置：直接回车，使用默认配置即可。</li></ul><p>最后保存后，使用 <code>rclone ls test:</code> 即可测试是否成功配置。</p><h2 id="obsidian-配置">Obsidian 配置</h2><p>小氯在 Obsidian 的配置上花了很多的时间，终于找到了一个自己满意的方案。下面我把思路整理一下。</p><p>小氯的需求大概是：</p><ul><li>图片重命名（语义化命名）</li><li>使用相对链接</li><li>自动压缩为 WebP 或者 AVIF</li><li>发布博客时上传到图床并替换博客文件的链接，而原本的文件保持不变</li></ul><p>为了方便，我们就叫粘贴处理和发布处理好了。</p><h3 id="粘贴处理">粘贴处理</h3><p>能实现一部分功能的 Obsidian 的图片插件有很多，例如 Paste Image Rename，Unique Attachments 等。不过小氯最喜欢的还是这个：</p><div class="p-8 rounded-xl backdrop-blur shadow-md shadow-accent/10 ring-1 ring-accent/10 hover:ring-accent/30 hover:shadow-lg hover:shadow-accent/20 hover:transition hover:duration-300"><div class="flex items-center justify-between mb-3"><a href="https://github.com/xRyul/obsidian-image-converter" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-lg font-medium text-foreground transition-colors plain-link"><div class="i-carbon-logo-github w-5 h-5"></div><span>xRyul/obsidian-image-converter</span></a></div><p class="mb-4 text-[15px] leading-relaxed text-foreground/80">⚡️ Convert, compress, resize, annotate, markup, draw, crop, rotate, flip, align images directly in Obsidian. Drag-resize, rename with variables, batch process. WEBP, JPG, PNG, HEIC, TIF.</p><div class="flex flex-wrap items-center gap-4 text-sm text-foreground/60"><div class="inline-flex items-center gap-1.5"><span class="w-3 h-3 rounded-full ring-1 ring-black/5 dark:ring-white/5" style="background-color:#2b7489"></span><span>TypeScript</span></div><div class="inline-flex items-center gap-1.5" title="Star 数"><div class="i-carbon-star w-4 h-4"></div><span class="tabular-nums">337</span></div><div class="inline-flex items-center gap-1.5" title="开源协议"><div class="i-carbon-license w-4 h-4"></div><span>MIT License</span></div><div class="inline-flex items-center gap-1.5" title="最后更新时间"><div class="i-carbon-time w-4 h-4"></div><span class="tabular-nums">2025-02-27</span></div></div></div><p>这个插件的功能非常全面，从压缩、格式转换、自定义附件位置到标注、裁剪、缩放、对齐都有。而作者也是位乐于听从社区意见的开发者，更新迭代和 Issue / PR 回复都很勤。小氯给这个插件提了个小小的 PR（改了一个拼写错误），混到了人生中第一个 Contributor 认证 (/ω＼)</p><p>不过插件的功能虽多，但是小氯主要是用其中的压缩和自定义附件位置，因此整体的功能也有些冗余了。而且，其会和我常用的 Attachflow 插件冲突。至于压缩问题，Image Converter 插件在 1.3.7 版本加入了 AVIF 压缩功能，不过有一个问题：<strong>它异常耗内存</strong>，经常转换着转换着就内存不足崩掉了（虽然说 FFmpeg AVIF 这玩意本来就吃资源）。虽然可以回退到 WebP，但是总归不是最优的解决方案。</p><p>那看来只有发挥主观能动性了。那么纵观 Obsidian 的插件，能让小氯在这个意义上发挥主观能动性的插件似乎只有一个：</p><div class="p-8 rounded-xl backdrop-blur shadow-md shadow-accent/10 ring-1 ring-accent/10 hover:ring-accent/30 hover:shadow-lg hover:shadow-accent/20 hover:transition hover:duration-300"><div class="flex items-center justify-between mb-3"><a href="https://github.com/Taitava/obsidian-shellcommands" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-lg font-medium text-foreground transition-colors plain-link"><div class="i-carbon-logo-github w-5 h-5"></div><span>Taitava/obsidian-shellcommands</span></a></div><p class="mb-4 text-[15px] leading-relaxed text-foreground/80">Execute system commands via hotkeys or command palette in Obsidian (https://obsidian.md). Some automated events are also supported, and execution via URI links.</p><div class="flex flex-wrap items-center gap-4 text-sm text-foreground/60"><div class="inline-flex items-center gap-1.5"><span class="w-3 h-3 rounded-full ring-1 ring-black/5 dark:ring-white/5" style="background-color:#2b7489"></span><span>TypeScript</span></div><div class="inline-flex items-center gap-1.5" title="Star 数"><div class="i-carbon-star w-4 h-4"></div><span class="tabular-nums">398</span></div><div class="inline-flex items-center gap-1.5" title="开源协议"><div class="i-carbon-license w-4 h-4"></div><span>GNU General Public License v3.0</span></div><div class="inline-flex items-center gap-1.5" title="最后更新时间"><div class="i-carbon-time w-4 h-4"></div><span class="tabular-nums">2025-01-01</span></div></div></div><p>Obsidian Shell Commands，我愿称之为 Ob 可玩性的 Top3 之一（另外两个小氯认为是 Local REST API 和 Quickadd）。这个插件的功能就是让你在 Obsidian 中调用系统的 Shell 执行命令，支持自定义变量、预输入和自动触发等。说到这里，大家应该也能想象到这个插件的可玩性有多强了。</p><p>而且，小氯本身也要用 Shell Commands，既然我们能少装一个插件，那么「如非必要，勿增实体」，自然是极好的。</p><p>首先，由于小氯的图片使用的是相对路径，因此需要先获取图片相对于当前笔记的路径。笔记路径有 <code>{{file_path}}</code> 变量，图片由于是我们自己规定的，因此也不难获得。问题在于路径的计算。macOS 没有现成的命令行工具计算相对路径，于是小氯写了个 Python 脚本：</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#A0A1A7;font-style:italic;--shiki-dark:#7F848E;--shiki-dark-font-style:italic">#!/usr/bin/env python3</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">import</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> os</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">import</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> sys</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">import</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> argparse</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">def</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> get_relpath</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic">base_dir</span><span style="color:#383A42;--shiki-dark:#ABB2BF">,</span><span style="color:#986801;font-style:inherit;--shiki-dark:#D19A66;--shiki-dark-font-style:italic"> tar_file</span><span style="color:#383A42;--shiki-dark:#ABB2BF">):</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    try</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">        relative_path </span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> os.path.</span><span style="color:#383A42;--shiki-dark:#61AFEF">relpath</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(tar_file, base_dir)</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        return</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> relative_path</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    except</span><span style="color:#0184BC;--shiki-dark:#ABB2BF"> ValueError</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">        return</span><span style="color:#986801;--shiki-dark:#D19A66"> None</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">def</span><span style="color:#4078F2;--shiki-dark:#61AFEF"> main</span><span style="color:#383A42;--shiki-dark:#ABB2BF">():</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    parser </span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> argparse.</span><span style="color:#383A42;--shiki-dark:#61AFEF">ArgumentParser</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">description</span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#50A14F;--shiki-dark:#98C379">"计算 target 相对于 base 的相对路径"</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    parser.</span><span style="color:#383A42;--shiki-dark:#61AFEF">add_argument</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">"base"</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">help</span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#50A14F;--shiki-dark:#98C379">"起始目录）"</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    parser.</span><span style="color:#383A42;--shiki-dark:#61AFEF">add_argument</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">"target"</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">help</span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#50A14F;--shiki-dark:#98C379">"目标文件"</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    args </span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> parser.</span><span style="color:#383A42;--shiki-dark:#61AFEF">parse_args</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    base_dir </span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> os.path.</span><span style="color:#383A42;--shiki-dark:#61AFEF">abspath</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(args.base)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    tar_file </span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> os.path.</span><span style="color:#383A42;--shiki-dark:#61AFEF">abspath</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(args.target)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    if</span><span style="color:#A626A4;--shiki-dark:#C678DD"> not</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> os.path.</span><span style="color:#383A42;--shiki-dark:#61AFEF">isabs</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(base_dir) </span><span style="color:#A626A4;--shiki-dark:#C678DD">or</span><span style="color:#A626A4;--shiki-dark:#C678DD"> not</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> os.path.</span><span style="color:#383A42;--shiki-dark:#61AFEF">isabs</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(tar_file):</span></span>
<span class="line"><span style="color:#0184BC;--shiki-dark:#56B6C2">        print</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">"Err: Please input absolute path."</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">file</span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#383A42;--shiki-dark:#ABB2BF">sys.stderr)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">        sys.</span><span style="color:#383A42;--shiki-dark:#61AFEF">exit</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">1</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">    relative_path </span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#383A42;--shiki-dark:#61AFEF"> get_relpath</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(base_dir, tar_file)</span></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    if</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> relative_path </span><span style="color:#A626A4;--shiki-dark:#C678DD">is</span><span style="color:#A626A4;--shiki-dark:#C678DD"> not</span><span style="color:#986801;--shiki-dark:#D19A66"> None</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#0184BC;--shiki-dark:#56B6C2">        print</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(relative_path)</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    else</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#0184BC;--shiki-dark:#56B6C2">        print</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#50A14F;--shiki-dark:#98C379">"Err: Please input correct path."</span><span style="color:#383A42;--shiki-dark:#ABB2BF">, </span><span style="color:#986801;font-style:inherit;--shiki-dark:#E06C75;--shiki-dark-font-style:italic">file</span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#383A42;--shiki-dark:#ABB2BF">sys.stderr)</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">        sys.</span><span style="color:#383A42;--shiki-dark:#61AFEF">exit</span><span style="color:#383A42;--shiki-dark:#ABB2BF">(</span><span style="color:#986801;--shiki-dark:#D19A66">1</span><span style="color:#383A42;--shiki-dark:#ABB2BF">)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">if</span><span style="color:#E45649;--shiki-dark:#E06C75"> __name__</span><span style="color:#383A42;--shiki-dark:#56B6C2"> ==</span><span style="color:#50A14F;--shiki-dark:#98C379"> "__main__"</span><span style="color:#383A42;--shiki-dark:#ABB2BF">:</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#61AFEF">    main</span><span style="color:#383A42;--shiki-dark:#ABB2BF">()</span></span>
<span class="line"></span></code></pre><p>然后赋予执行权限，移动到 <code>~/.local/bin</code> 了事。</p><p>下面我们需要读取剪贴板的图片，这里由于是 macOS，我们使用最原生的 AppleScript 即可。</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">on</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> run</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> args</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    set</span><span style="color:#E45649;--shiki-dark:#E06C75"> outputFile</span><span style="color:#A626A4;--shiki-dark:#C678DD"> to</span><span style="color:#C18401;--shiki-dark:#E5C07B"> POSIX file</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (first </span><span style="color:#0184BC;--shiki-dark:#56B6C2">item</span><span style="color:#A626A4;--shiki-dark:#C678DD"> of</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> args)</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    try</span></span>
<span class="line"><span style="color:#0184BC;--shiki-dark:#56B6C2">        write</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> (</span><span style="color:#A626A4;--shiki-dark:#C678DD">the</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> clipboard </span><span style="color:#383A42;--shiki-dark:#C678DD">as</span><span style="color:#986801;--shiki-dark:#D19A66"> «</span><span style="color:#C18401;--shiki-dark:#E5C07B">class</span><span style="color:#986801;--shiki-dark:#D19A66"> PNGf»</span><span style="color:#383A42;--shiki-dark:#ABB2BF">) to outputFile</span></span>
<span class="line"><span style="color:#986801;--shiki-dark:#D19A66">        return</span><span style="color:#0184BC;--shiki-dark:#56B6C2"> POSIX path</span><span style="color:#A626A4;--shiki-dark:#C678DD"> of</span><span style="color:#383A42;--shiki-dark:#ABB2BF"> outputFile</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    on error</span></span>
<span class="line"><span style="color:#986801;--shiki-dark:#D19A66">        return</span><span style="color:#50A14F;--shiki-dark:#98C379"> "ERROR: 剪贴板中没有图片"</span></span>
<span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">    end try</span></span>
<span class="line"><span style="color:#383A42;--shiki-dark:#ABB2BF">end </span><span style="color:#0184BC;--shiki-dark:#56B6C2">run</span></span></code></pre><p>然后把图片存储到临时文件 <code>TMPFILE="$(mktemp "/tmp/pasteboard-XXXXXX.jpg")"</code> 中。当然不要忘了加一个 trap 自动清理。</p><p>然后我们需要获取新图片的名字。为了满足小氯的需求，我们加一个 Preaction，让我们可以自己输入文件名。</p><p></p><figure class="my-8"><img src="https://img.clnya.fun/20250220-compress-preaction.avif" alt="compress-preaction" class="mx-auto rounded-lg block" loading="lazy" width="520"></figure><p></p><p>然后我们就要开始压缩了。小氯第一个想到的自然是古神 FFmpeg，不过大家也知道，FFmpeg 尊者是出了名地脾气古怪，只要你稍微不慎，就会让他老人家掀桌不干。小氯反反复复调了好几次，遇到的问题包括但是不限于：</p><ul><li>压缩极慢。</li><li>都把输出重定向到 <code>/dev/null</code> 了，还是莫名其妙地冒日志。</li><li>好不容易能压缩了，结果透明度数据没了，告诉我 libaom-av1 不支持 YUVA 编码。</li></ul><p>……好好好。</p><p>那我不用 FFmpeg 还不行吗？！</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">rustup</span><span style="color:#50A14F;--shiki-dark:#98C379"> update</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">cargo</span><span style="color:#50A14F;--shiki-dark:#98C379"> install</span><span style="color:#50A14F;--shiki-dark:#98C379"> cavif</span></span></code></pre><p>这玩意也不是不能用，而且比 FFmpeg 快多了。</p><p>压缩之后，我们就可以把图片移动到对应的附件文件夹，并且向剪贴板写入我们的相对路径链接了。小氯也尝试过把数据写入剪贴板，但是 macOS 似乎不直接支持写入 AVIF。</p><p>完整版的脚本放在<a href="https://gist.viento.cc/chlorine/e644da399d2d48c29bc9177622233ef6">这里</a>了，大家按需取用。</p><h3 id="发布处理">发布处理</h3><p>由于小氯的 Hermeneutics 支持 Wikilink 和 Alert，所以我们只需要上传图片并替换即可。这里我们还是写脚本解决问题。</p><p>这个脚本比较简单，使用 ripgrep 查找图片，再通过文件的路径构建出图片路径，然后一个循环把图片送上去即可。小氯用了 Cloudflare R2 测试成功后就放心地把脚本归档了。直到小氯写<a href="/hello-cefiro/">上一篇文章</a>，希望调用脚本上传图片时，才发现：</p><blockquote class="my-6 border-l-4 border-border/60 pl-4"><p>你根本没在又拍云！你在哪呢？</p></blockquote><p>图片并没有被上传到又拍云。于是，小氯开始了兵荒马乱的排查过程，最终在单独测试 <code>rclone copyto</code> 时发现了一大堆奇奇怪怪的报错，不是超时就是缺少 Key 或者各种万泉部诗人的奇怪报错。这可能是因为牢拍的存储空间不完全符合 AWS S3 的标准，所以说 rclone 没办法很好地兼容。</p><p>好好好。支持，但是不完全支持。</p><p>万般无奈之下小氯开始寻找替代方案，在把又拍云的文档翻了个底朝天之后，小氯终于找到了这个东西：</p><div class="p-8 rounded-xl backdrop-blur shadow-md shadow-accent/10 ring-1 ring-accent/10 hover:ring-accent/30 hover:shadow-lg hover:shadow-accent/20 hover:transition hover:duration-300"><div class="flex items-center justify-between mb-3"><a href="https://github.com/upyun/upx" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-lg font-medium text-foreground transition-colors plain-link"><div class="i-carbon-logo-github w-5 h-5"></div><span>upyun/upx</span></a></div><p class="mb-4 text-[15px] leading-relaxed text-foreground/80">UPYUN Storage Command Tool</p><div class="flex flex-wrap items-center gap-4 text-sm text-foreground/60"><div class="inline-flex items-center gap-1.5"><span class="w-3 h-3 rounded-full ring-1 ring-black/5 dark:ring-white/5" style="background-color:#00add8"></span><span>Go</span></div><div class="inline-flex items-center gap-1.5" title="Star 数"><div class="i-carbon-star w-4 h-4"></div><span class="tabular-nums">198</span></div><div class="inline-flex items-center gap-1.5" title="开源协议"><div class="i-carbon-license w-4 h-4"></div><span>MIT License</span></div><div class="inline-flex items-center gap-1.5" title="最后更新时间"><div class="i-carbon-time w-4 h-4"></div><span class="tabular-nums">2025-02-11</span></div></div></div><p>这个东西不能用 Homebrew 安装（或许小氯可以自己维护一个？），同时小氯的系统里已经有一个叫 <code>upx</code> 的家伙了（一个压缩可执行文件的工具，可以把 C++ 编译出的 <code>./hello-world</code> 大小压缩一半<del>并且使得其报错</del>）。所以，我们采取一下自定义安装策略。</p><p>首先把东西下载下来：</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">wget</span><span style="color:#50A14F;--shiki-dark:#98C379"> https://collection.b0.upaiyun.com/softwares/upx/upx_0.4.8_darwin_arm64.tar.gz</span></span></code></pre><p>然后解压缩（或者直接用命令行解压缩也行，看您方便），再移动到 PATH 里面：</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">sudo</span><span style="color:#50A14F;--shiki-dark:#98C379"> mv</span><span style="color:#50A14F;--shiki-dark:#98C379"> /path/to/upx</span><span style="color:#50A14F;--shiki-dark:#98C379"> /usr/local/bin/upyun</span></span></code></pre><p>然后验证一下就可以了。</p><p>这个命令行工具不支持使用文件验证，所以我们把凭据写到环境变量里面就好。</p><pre class="shiki shiki-themes one-light one-dark-pro" style="background-color:#FAFAFA;--shiki-dark-bg:#282c34;color:#383A42;--shiki-dark:#abb2bf" tabindex="0"><code><span class="line"><span style="color:#A626A4;--shiki-dark:#C678DD">alias</span><span style="color:#E45649;--shiki-dark:#E06C75"> upyun</span><span style="color:#383A42;--shiki-dark:#56B6C2">=</span><span style="color:#50A14F;--shiki-dark:#98C379">"/usr/local/bin/upyun"</span></span>
<span class="line"><span style="color:#4078F2;--shiki-dark:#61AFEF">upyun</span><span style="color:#50A14F;--shiki-dark:#98C379"> login</span><span style="color:#50A14F;--shiki-dark:#98C379"> {{_UPYUN_SERVICE_NAME}}</span><span style="color:#50A14F;--shiki-dark:#98C379"> {{_UPYUN_OPERATOR}}</span><span style="color:#50A14F;--shiki-dark:#98C379"> {{_UPYUN_SECRET}}</span></span></code></pre><p>然后上传完成退出就好了。</p><p>这个方法非常别扭，但是没办法，这是目前小氯找到的唯一一个能跑起来的方法了。</p><p>同样的，老友们可以<a href="https://gist.viento.cc/chlorine/4f9d0a497ca647e5ab35154fb2408693">自取脚本</a>。</p><p>Shell Commands 真的是太强大了，小氯写了若干个脚本，几乎完全替代了 Image Converter、Git 等插件。如果再配合一下 Local REST API 和 Obsidian URI，大概可以把目前小氯的大部分插件都替代掉了。</p><h2 id="后记">后记</h2><p>又清掉了一篇草稿，好耶 ～(∠・ω&#x3C; )⌒☆​</p></article><div class="mt-12 md:mt-16 pt-6 md:pt-8 border-t border-border/40 dark:border-border-dark/40"><div class="space-y-6"><div class="flex items-center gap-3"><div class="flex items-center gap-2 px-3 py-1.5 rounded-full text-primary/80 dark:text-primary-dark/80"><div class="i-carbon-notebook w-4 h-4"></div><span class="text-sm font-medium">系列文章：理想乡构筑手记</span></div><span class="px-2 py-0.5 text-xs rounded-md text-muted-foreground/60 dark:text-muted-foreground-dark/60 ring-1 ring-border/30 dark:ring-border-dark/30">4 篇</span></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 plain-link-container"><a href="/hello-cefiro/" class="group p-4 rounded-lg ring-1.5 ring-gray-500/20 dark:ring-gray-600/40 backdrop-blur transition duration-300 hover:ring-gray-600/30 dark:hover:ring-gray-500/30"><div class="flex items-center gap-2 text-sm text-muted-foreground/70 mb-1"><div class="i-carbon-arrow-left w-4 h-4"></div><span>上一篇</span></div><h3 class="mt-1 text-base font-medium line-clamp-1 transition-colors">理想乡构筑手记（2）：Hello，Céfiro</h3></a><a href="/hello-chlor-me/" class="group p-4 rounded-lg backdrop-blur ring-1.5 ring-gray-500/20 dark:ring-gray-600/40 transition duration-300 hover:ring-gray-600/30 dark:hover:ring-gray-500/30"><div class="flex items-center justify-end gap-2 text-sm text-muted-foreground/70 mb-1"><span>下一篇</span><div class="i-carbon-arrow-right w-4 h-4"></div></div><h3 class="mt-1 text-base font-medium line-clamp-1 text-right transition-colors">理想乡构筑手记（4）：新的域名及一些杂谈</h3></a></div></div></div><div class="mt-12 md:mt-16 p-6 rounded-xl border border-border/40 dark:border-border-dark/40 backdrop-blur"><div class="flex flex-col sm:flex-row gap-6"><div class="hidden sm:block flex-shrink-0"><div class="w-14 h-14 rounded-xl border border-border/40 dark:border-border-dark/40 bg-accent/30 dark:bg-accent-dark/30 flex items-center justify-center"><div class="i-carbon-license w-7 h-7 text-primary/80"></div></div></div><div class="flex-1 space-y-4"><div class="space-y-1"><h3 class="text-base font-medium">版权声明</h3><div class="flex flex-wrap items-center gap-x-2 gap-y-1 text-sm text-muted-foreground/70"><span>本文采用</span>
<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1 text-primary/80 hover:text-primary transition-colors"><div class="i-carbon-link w-3.5 h-3.5"></div><span>CC BY-NC-SA 4.0</span>
</a><span>许可协议。</span></div></div><div class="text-sm space-y-2 text-muted-foreground/70"><div class="flex items-start gap-2"><div class="i-carbon-checkmark w-4 h-4 mt-0.5 text-primary/70"></div><span>转载请注明出处：<span class="select-all">https://chlor.me/hello-nieve/</span></span></div><div class="flex items-start gap-2"><div class="i-carbon-checkmark w-4 h-4 mt-0.5 text-primary/70"></div><span>本文作者：Chlorine</span></div><div class="flex items-start gap-2"><div class="i-carbon-checkmark w-4 h-4 mt-0.5 text-primary/70"></div><span>发布时间：<time class="tabular-nums">2025-02-21 00:00</time></span></div></div></div></div></div><link rel="stylesheet" href="/css/components/comments/twikoo.min.0c1c68a789714e0d50c874179f667a51d380faebfbfe7a1649e72b6e87f4138f.css" integrity="sha256-DBxop4lxTg1QyHQXn2Z6UdOA+uv7/noWSecrbof0E48=" crossorigin="anonymous"><div class="mt-12 md:mt-16 pt-6 md:pt-8 border-t border-border/40 dark:border-border-dark/40"><div class="flex items-center gap-2 mb-8"><div class="i-carbon-chat w-5 h-5 text-primary/80"></div><h3 class="text-lg font-medium">评论</h3></div><div id="twikoo" class="plain-link"></div></div><script src="https://cdn.jsdmirror.com/gh/chlorine3545/customcdn@2b63d63/js/twikoo/1_6_41.min.js" crossorigin="anonymous" defer></script><script>window.addEventListener("load",()=>{twikoo.init({envId:"https://tk.viento.cc",el:"#twikoo",lang:"zh-CN"})})</script><script src="/js/components/twikoo-owo.js" defer></script></div><aside class="hidden lg:block w-64 flex-shrink-0"><div class="sticky top-24 flex flex-col gap-6"><link rel="stylesheet" href="/css/components/article/toc.css"><div class="flex flex-col gap-4"><h3 class="text-sm font-medium text-foreground/80">目录</h3><nav class="text-sm text-foreground/70"><nav id="TableOfContents"><ul><li><a href="#tl--dr">TL ; DR</a></li><li><a href="#前言">前言</a></li><li><a href="#图片服务的选择">图片服务的选择</a></li><li><a href="#使用-rclone-备份图片">使用 <code>rclone</code> 备份图片</a></li><li><a href="#又拍云的配置">又拍云的配置</a><ul><li><a href="#申请又拍云联盟">申请又拍云联盟</a></li><li><a href="#创建存储服务">创建存储服务</a></li><li><a href="#使用-rclone-重新上传图片">使用 <code>rclone</code> 重新上传图片</a></li></ul></li><li><a href="#obsidian-配置">Obsidian 配置</a><ul><li><a href="#粘贴处理">粘贴处理</a></li><li><a href="#发布处理">发布处理</a></li></ul></li><li><a href="#后记">后记</a></li></ul></nav></nav></div><div class="flex flex-col gap-4"><h3 class="text-sm font-medium text-foreground/80">阅读进度</h3><div class="relative h-1 bg-border/50 rounded-full overflow-hidden"><div id="reading-progress" class="absolute inset-y-0 left-0 bg-primary/80 transition-all duration-150" style="width:0%"></div></div><div class="text-sm text-muted-foreground text-center"><span id="percent">0</span>% 已读</div></div><script src="/js/components/reading-progress.5f39156caf6576d6ce40fdecfcab492aeda6ea0932e102e04845c9361be5caa8.js" integrity="sha256-XzkVbK9ldtbOQP3s/KtJKu2m6gky4QLgSEXJNhvlyqg=" crossorigin="anonymous" defer></script></div></aside></div><div id="reading-progress-ball" class="lg:hidden fixed right-4 bottom-20 w-12 h-12 rounded-full backdrop-blur z-50 shadow-lg border border-border/20 dark:border-border-dark/20 flex items-center justify-center text-sm font-medium tabular-nums transition-all duration-300 transform translate-y-24 opacity-0">0%</div><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("reading-progress-ball");if(!e)return;const n=document.querySelector("article");if(!n)return;function t(){const s=n.getBoundingClientRect(),r=window.innerHeight,c=-s.top,o=s.height,l=Math.min(r,o),i=o-l;let t=c/i*100;t=Math.min(100,Math.max(0,t));const d=Math.round(t);e.textContent=`${d}%`;const a=t>0&&t<100&&i>0;e.classList.toggle("translate-y-24",!a),e.classList.toggle("opacity-0",!a)}function s(e,t){let s,n=0;return function(...o){const i=Date.now(),a=this;i-n>=t?(e.apply(a,o),n=i):(clearTimeout(s),s=setTimeout(()=>{e.apply(a,o),n=Date.now()},t))}}window.addEventListener("scroll",s(t,100),{passive:!0}),window.addEventListener("resize",s(t,100),{passive:!0}),t()})</script></div></div></div></main></div><footer class="plain-link-container mt-auto py-4 backdrop-blur border-t border-border/50"><div class="container mx-auto px-4"><div class="flex flex-col gap-6"><div class="hidden mt-3 md:flex items-center gap-4 text-sm text-muted-foreground/70"><div class="flex items-center gap-2"><div class="i-carbon-time w-4 h-4"></div><span class="tabular-nums font-mono tracking-wider"><span class="text-primary/70">已运行</span>
<span id="runningtime" class="ml-1" data-start-date="12/15/2023 12:00:00"></span></span></div><script src="/js/components/runtime.9e9d6de2edbc0c1fd1e49fe58f78438aec2e85362f4d69d1494d517bdd32611b.js" integrity="sha256-np1t4u28DB/R5J/lj3hDiuwuhTYvTWnRSU1Re90yYRs=" crossorigin="anonymous" defer></script><span class="w-1 h-1 rounded-full bg-muted-foreground/30"></span><div class="flex items-center gap-2"><div class="i-carbon-text-font w-4 h-4"></div><span>共 <span class="tabular-nums font-mono">233610</span> 字
<span class="mx-1">·</span>
写完一本 简·奥斯汀 的《傲慢与偏见》了!</span></div></div><div class="hidden md:visible h-px bg-border/10"></div><div class="flex flex-col md:flex-row items-center justify-between gap-3 text-sm text-muted-foreground/60"><div class="flex flex-col md:flex-row items-center gap-2 md:gap-4"><span>© 2025 Chlorine</span><div class="flex items-center gap-4"><span>Powered by <a href="https://gohugo.io" target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors">Hugo</a></span>
<span>Theme <a href="https://github.com/chlorine3545/hugo-theme-hermeneutics" target="_blank" rel="noopener noreferrer" class="hover:text-primary transition-colors">Hermeneutics</a></span></div></div><div class="flex flex-col md:flex-row items-center gap-2 md:gap-4"><a href="https://beian.miit.gov.cn/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 hover:text-primary transition-colors"><span>京ICP备2024074926号-5</span>
</a><span class="hidden md:inline text-border/40">|</span>
<a href="http://www.beian.gov.cn/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 hover:text-primary transition-colors"><span>京公网安备11010802044863号</span>
</a><span class="hidden md:inline text-border/40">|</span>
<a href="https://icp.gov.moe/" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-1.5 hover:text-primary transition-colors"><span>萌ICP备20240711号</span></a></div></div></div></div></footer><footer><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("loading-screen");let t;function n(){e&&(e.style.opacity="0",setTimeout(()=>{e.style.display="none"},400)),t&&(clearTimeout(t),t=null)}function s(){e&&(e.style.display="flex",e.offsetHeight,e.style.opacity="1",t=setTimeout(n,3e3))}window.addEventListener("load",n),window.addEventListener("pageshow",function(e){e.persisted&&n()}),document.addEventListener("click",function(e){const t=e.target.closest("a");t&&t.href&&!t.href.startsWith("#")&&!t.href.includes("#")&&t.href!==window.location.href&&!t.hasAttribute("download")&&t.target!=="_blank"&&t.hostname===window.location.hostname&&(e.preventDefault(),s(),setTimeout(()=>{window.location.href=t.href},500))}),n()})</script></footer></body></html>